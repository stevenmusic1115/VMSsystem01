/**
 * Victoria Music School - Complete System with Fees
 * google.script.run ç‰ˆæœ¬ - å®Œå…¨é¿å… CORS
 */

// ==================== é…ç½® ====================
const SPREADSHEET_ID = '1qd4AZ5y9gl5X82gaPuLI43uk86zoZ0PFKqngWMhKdds';
const WEEK_DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
const STOP_MARKER = 'TRIAL LESSONS';

const COLUMN_INDEX = {
  REGIST_DATE: 1,
  STUDENT_NO: 2,
  CONTACT: 3,
  TIME: 4,
  STUDENT_NAME: 5,
  REMARK: 6,
  GENDER: 7,
  AGE1: 8,
  AGE2: 9,
  GRADE: 10,
  FEES: 11  // K æ¬„ = ç¬¬ 11 æ¬„
};

// ==================== Web App å…¥å£ ====================
function doGet(e) {
  // æª¢æŸ¥æ˜¯å¦æœ‰ token åƒæ•¸ï¼ˆè€å¸«å°ˆå±¬é€£çµï¼‰
  if (e && e.parameter && e.parameter.t) {
    const token = e.parameter.t;
    const verification = verifyTeacherToken(token);
    
    if (verification.success) {
      const template = HtmlService.createTemplateFromFile('index');
      template.teacherName = verification.teacherName;
      template.teacherToken = token;
      return template.evaluate()
        .setTitle('ğŸ° Victoria Music School')
        .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
    } else {
      return HtmlService.createHtmlOutput('<h1>é€£çµç„¡æ•ˆ</h1><p>è«‹è¯çµ¡ç®¡ç†å“¡</p>');
    }
  }
  
  // ä¸€èˆ¬è¨ªå•
  const template = HtmlService.createTemplateFromFile('index');
  template.teacherName = '';
  template.teacherToken = '';
  return template.evaluate()
    .setTitle('ğŸ° Victoria Music School')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// ==================== ä¾›å‰ç«¯å‘¼å«çš„å‡½æ•¸ ====================
function getAllData() {
  Logger.log('é–‹å§‹æå–æ‰€æœ‰è³‡æ–™...');
  
  const teachers = getTeachersData();
  const students = getStudentsData();
  
  return {
    teachers: teachers,
    students: students,
    lastUpdate: new Date().toISOString(),
    version: '3.1'
  };
}

function verifyPassword(role, password) {
  const props = PropertiesService.getScriptProperties();
  const teacherPassword = props.getProperty('TEACHER_PASSWORD') || '1234';
  const adminPassword = props.getProperty('ADMIN_PASSWORD') || 'Vivi613575$$';
  
  if (role === 'teacher') {
    return { success: password === teacherPassword };
  } else if (role === 'admin') {
    return { success: password === adminPassword };
  }
  
  return { success: false };
}

// ==================== æå–è€å¸«è³‡æ–™ ====================
function getTeachersData() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const teachers = {};
  
  WEEK_DAYS.forEach(day => {
    const sheet = ss.getSheetByName(day);
    if (!sheet) return;
    
    const data = sheet.getDataRange().getValues();
    if (data.length === 0) return;
    
    const teacherBlocks = findTeacherBlocks(data);
    
    teacherBlocks.forEach((block, index) => {
      const teacherName = block.teacherName;
      
      if (!teachers[teacherName]) {
        teachers[teacherName] = {
          name: teacherName,
          instruments: new Set(),
          students: new Set(),
          schedule: {
            Monday: [], Tuesday: [], Wednesday: [], Thursday: [],
            Friday: [], Saturday: [], Sunday: []
          }
        };
      }
      
      const startRow = block.headerRow + 1;
      const endRow = index < teacherBlocks.length - 1 ? 
                     teacherBlocks[index + 1].teacherRow - 1 : 
                     data.length - 1;
      
      let lastValidTime = '';
      
      for (let i = startRow; i <= endRow; i++) {
        const row = data[i];
        
        if (isStopMarker(row)) break;
        
        const studentNo = row[COLUMN_INDEX.STUDENT_NO - 1];
        let time = row[COLUMN_INDEX.TIME - 1];
        const studentName = row[COLUMN_INDEX.STUDENT_NAME - 1];
        
        if (time && String(time).trim()) {
          lastValidTime = String(time).trim();
        } else if (studentNo && studentName && lastValidTime) {
          time = lastValidTime;
        }
        
        if (!studentNo || !time || !studentName) continue;
        if (isSpecialRow(time, studentName)) continue;
        
        const studentId = String(studentNo).trim();
        const timeStr = String(time).trim();
        const nameStr = String(studentName).trim();
        const instrument = inferInstrument(studentId, block.teacherType);
        
        teachers[teacherName].schedule[day].push({
          student_id: studentId,
          student_name: nameStr,
          time: timeStr,
          instrument: instrument
        });
        
        if (instrument) teachers[teacherName].instruments.add(instrument);
        teachers[teacherName].students.add(studentId);
      }
    });
  });
  
  Object.keys(teachers).forEach(teacherName => {
    teachers[teacherName].instruments = Array.from(teachers[teacherName].instruments);
    teachers[teacherName].students = Array.from(teachers[teacherName].students);
  });
  
  return teachers;
}

// ==================== æå–å­¸ç”Ÿè³‡æ–™ï¼ˆå«å­¸è²»ï¼‰====================
function getStudentsData() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const students = {};
  
  WEEK_DAYS.forEach(day => {
    const sheet = ss.getSheetByName(day);
    if (!sheet) return;
    
    const data = sheet.getDataRange().getValues();
    const teacherBlocks = findTeacherBlocks(data);
    
    teacherBlocks.forEach((block, index) => {
      const teacherName = block.teacherName;
      const startRow = block.headerRow + 1;
      const endRow = index < teacherBlocks.length - 1 ? 
                     teacherBlocks[index + 1].teacherRow - 1 : 
                     data.length - 1;
      
      let lastValidTime = '';
      
      for (let i = startRow; i <= endRow; i++) {
        const row = data[i];
        
        if (isStopMarker(row)) break;
        
        const studentNo = row[COLUMN_INDEX.STUDENT_NO - 1];
        const contact = row[COLUMN_INDEX.CONTACT - 1];
        let time = row[COLUMN_INDEX.TIME - 1];
        const remark = row[COLUMN_INDEX.REMARK - 1];
        const studentName = row[COLUMN_INDEX.STUDENT_NAME - 1];
        const gender = row[COLUMN_INDEX.GENDER - 1];
        const age1 = row[COLUMN_INDEX.AGE1 - 1];
        const grade = row[COLUMN_INDEX.GRADE - 1];
        const fees = row[COLUMN_INDEX.FEES - 1];  // æ–°å¢ï¼šK æ¬„å­¸è²»
        
        if (remark && String(remark).match(/\d{1,2}:\d{2}\s*(am|pm)?/i)) continue;
        
        if (time && String(time).trim()) {
          lastValidTime = String(time).trim();
        } else if (studentNo && studentName && lastValidTime) {
          time = lastValidTime;
        }
        
        if (!studentNo || !time || !studentName) continue;
        if (isSpecialRow(time, studentName)) continue;
        
        const studentId = String(studentNo).trim();
        const timeStr = String(time).trim();
        const nameStr = String(studentName).trim();
        const contactStr = contact ? String(contact).replace(/\s/g, '') : '';
        const feesStr = fees ? String(fees).trim() : '';  // æ–°å¢ï¼šè™•ç†å­¸è²»
        
        if (!students[studentId]) {
          const instrument = inferInstrument(studentId, block.teacherType);
          
          students[studentId] = {
            id: studentId,
            name: nameStr,
            contact: contactStr,
            instrument: instrument,
            age: age1 ? String(age1) : '',
            grade: grade ? String(grade) : '',
            gender: gender ? String(gender) : '',
            fees: feesStr,  // æ–°å¢ï¼šå„²å­˜å­¸è²»åŸå§‹è³‡æ–™
            teachers: {},
            schedule: {},
            instruments: {}
          };
        }
        
        if (contactStr && contactStr.length > students[studentId].contact.length) {
          students[studentId].contact = contactStr;
        }
        
        // æ–°å¢ï¼šå¦‚æœæœ‰å­¸è²»è³‡æ–™ä¸”ç•¶å‰å­¸ç”Ÿæ²’æœ‰ï¼Œå‰‡æ›´æ–°
        if (feesStr && !students[studentId].fees) {
          students[studentId].fees = feesStr;
        }
        
        const dayInstrument = inferInstrument(studentId, block.teacherType);
        
        if (students[studentId].schedule[day]) {
          if (!Array.isArray(students[studentId].schedule[day])) {
            const oldTime = students[studentId].schedule[day];
            const oldTeacher = students[studentId].teachers[day];
            const oldInstrument = students[studentId].instruments[day];
            
            students[studentId].schedule[day] = [oldTime, timeStr];
            students[studentId].teachers[day] = [oldTeacher, teacherName];
            students[studentId].instruments[day] = [oldInstrument, dayInstrument];
          } else {
            students[studentId].schedule[day].push(timeStr);
            students[studentId].teachers[day].push(teacherName);
            students[studentId].instruments[day].push(dayInstrument);
          }
        } else {
          students[studentId].schedule[day] = timeStr;
          students[studentId].teachers[day] = teacherName;
          students[studentId].instruments[day] = dayInstrument;
        }
      }
    });
  });
  
  return students;
}

// ==================== è¼”åŠ©å‡½æ•¸ ====================
function findTeacherBlocks(data) {
  const blocks = [];
  
  for (let i = 0; i < data.length; i++) {
    const row = data[i];
    if (isStopMarker(row)) return blocks;
    
    let teacherFound = false;
    let teacherName = '';
    let teacherType = '';
    
    for (let j = 0; j < Math.min(row.length, 10); j++) {
      const cell = row[j];
      if (cell && String(cell).includes('Teacher:')) {
        teacherType = String(cell);
        teacherFound = true;
        
        for (let k = j + 1; k < Math.min(j + 5, row.length); k++) {
          const nameCell = row[k];
          if (nameCell && String(nameCell).trim() && 
              !String(nameCell).includes('2025') && 
              String(nameCell).trim().length > 1) {
            teacherName = String(nameCell).trim();
            break;
          }
        }
        break;
      }
    }
    
    if (teacherFound && teacherName) {
      let headerRow = i + 1;
      for (let h = i + 1; h < Math.min(i + 5, data.length); h++) {
        const headerRowData = data[h];
        if (headerRowData[COLUMN_INDEX.STUDENT_NO - 1] && 
            String(headerRowData[COLUMN_INDEX.STUDENT_NO - 1]).includes('Student No')) {
          headerRow = h;
          break;
        }
      }
      
      blocks.push({
        teacherRow: i,
        teacherName: teacherName,
        teacherType: teacherType,
        headerRow: headerRow
      });
    }
  }
  
  return blocks;
}

function isSpecialRow(time, studentName) {
  const timeStr = String(time).toLowerCase();
  const nameStr = String(studentName).toLowerCase();
  
  if (timeStr.includes('time') && (nameStr.includes('student') || nameStr.includes('name'))) return true;
  if (nameStr.includes('student name') || nameStr.includes('student no')) return true;
  if (timeStr === 'time' || nameStr === 'name') return true;
  
  const specialKeywords = ['free slot', 'free trial', 'dinner', 'lunch', 'break', 'rest', 'student no', 'regist', 'contact'];
  
  for (const keyword of specialKeywords) {
    if (timeStr.includes(keyword) || nameStr.includes(keyword)) return true;
  }
  
  return false;
}

function isStopMarker(row) {
  for (let j = 0; j < Math.min(row.length, 10); j++) {
    const cell = row[j];
    if (!cell) continue;
    if (String(cell).toUpperCase().includes(STOP_MARKER)) return true;
  }
  return false;
}

function inferInstrument(studentId, teacherType) {
  const id = String(studentId).toUpperCase();
  
  if (id.startsWith('VC')) return 'Vocal';
  if (id.startsWith('V')) return 'Violin';
  
  if (id.includes('GCG') || id.includes('GAG') || id.includes('GEG') || 
      id.startsWith('CG') || id.startsWith('AG') || id.startsWith('EG') || 
      id.startsWith('G')) return 'Guitar';
  
  if (id.includes('UG') || id.startsWith('U')) return 'Ukulele';
  if (id.startsWith('TG')) return 'Theory';
  if (id.startsWith('PA') || id.startsWith('P')) return 'Piano';
  
  if (teacherType) {
    const type = String(teacherType).toLowerCase();
    if (type.includes('vocal')) return 'Vocal';
    if (type.includes('piano')) return 'Piano';
    if (type.includes('guitar')) return 'Guitar';
    if (type.includes('violin')) return 'Violin';
    if (type.includes('ukulele')) return 'Ukulele';
  }
  
  return 'Unknown';
}

// ==================== è€å¸« Token ç›¸é—œ ====================
function verifyTeacherToken(token) {
  const props = PropertiesService.getScriptProperties();
  const teacherName = props.getProperty('TEACHER_TOKEN_' + token);
  
  if (teacherName) {
    return { success: true, teacherName: teacherName };
  }
  
  return { success: false };
}

function generateRandomToken() {
  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
  let token = '';
  for (let i = 0; i < 8; i++) {
    token += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return token;
}

function generateTeacherLinks() {
  const props = PropertiesService.getScriptProperties();
  const teachers = getTeachersData();
  const webAppUrl = ScriptApp.getService().getUrl();
  
  Logger.log('====== è€å¸«å°ˆå±¬é€£çµ ======');
  Logger.log('');
  
  Object.values(teachers).forEach(teacher => {
    const token = generateRandomToken();
    props.setProperty('TEACHER_TOKEN_' + token, teacher.name);
    const link = webAppUrl + '?t=' + token;
    
    Logger.log('è€å¸«ï¼š' + teacher.name);
    Logger.log('é€£çµï¼š' + link);
    Logger.log('');
  });
  
  Logger.log('====== ç”Ÿæˆå®Œæˆ ======');
  return 'é€£çµå·²ç”Ÿæˆï¼Œè«‹æŸ¥çœ‹åŸ·è¡Œè¨˜éŒ„';
}

// ==================== è¨­å®šç®¡ç†å“¡å¯†ç¢¼ ====================
function updateAdminPassword() {
  const props = PropertiesService.getScriptProperties();
  props.setProperty('ADMIN_PASSWORD', 'Vivi613575$$');
  Logger.log('ç®¡ç†å“¡å¯†ç¢¼å·²æ›´æ–°ç‚º: Vivi613575$$');
}
